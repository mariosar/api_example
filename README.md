# README

This README would normally document whatever steps are necessary to get the
application up and running.

Things you may want to cover:

* Ruby version

* System dependencies

* Configuration

* Database creation

* Database initialization

* How to run the test suite

* Services (job queues, cache servers, search engines, etc.)

* Deployment instructions

* ...

rails new api_test --api
bundle install
rake db:create

Add to Gemfile
# inside test / development
gem 'rspec-rails'
gem 'factory_girl_rails'
# all
gem 'active_model_serializers'
bundle install

rails g rspec:install

# Tell our serializer to use json:api standard
# https://jsonapi.org/
touch config/initializers/active_model_serializers.rb
ActiveModelSerializers.config.adapter = ActiveModelSerializers::Adapter::JsonApi

# CORS
gem 'rack-cors'
# https://github.com/cyu/rack-cors
bundle install
# Edit config/application.rb allow (origin, resource, method)
config.middleware.insert_before 0, Rack::Cors do
  allow do
    origins '*'
    resource '*', headers: :any, methods: [:get, :post, :options]
  end
end
# Test CORS on localhost using chrome
# $.ajax("http://localhost:3000/api/v1/users")

# Rate Limiting / Throttling
gem 'rack-attack'
# https://github.com/kickstarter/rack-attack
bundle install
# Edit config/application.rb to add Rack Attack middleware
config.middleware.use Rack::Attack
touch config/initializers/rack_attack.rb
# Add rules for whitelisting localhost, throttling to limit # of requests per x seconds, and logging requests
# Try adding a throttling rule and then test requests to break it and see the result

rails g model user name email
rails g serializer user
rails g scaffold_controller api::v1::users --model-name=user
# The specs generated by scaffold don't really generate the correct code (paths and model will be incorrect)

# User cUrl to make requests
curl -X GET -H "Accept: application/json" "localhost:3000/api/v1/users"
curl -X POST -H "Accept: application/json" -H "Content-Type: application/json" -d '{"user": {"name": "Mario", "email": "mario@gmail.com"}}' "localhost:3000/api/v1/users"
curl -X PUT ation/json" -H "Content-Type: application/json" -d '{"email": "mario.saraiva@gmail.com"}' "localhost:3000/api/v1/users/2"
curl -X DELETE "localhost:3000/api/v1/users/1"

### Deployment to HEROKU

# Switch to PG
remove gem 'sqlite3'
add gem 'pg'
# In database.yml -> change:
# adapter: postgresql
# host: localhost
# encoding: unicode
# database: api_example_<env>
# username: api_example
# password: your_password

# Terminal
# sudo -u postgresql psql
# create database api_example_<env>
# create user api_example with encrypted password 'secretpass';
# grant all privileges on database api_example_development to api_example;

rake db:migrate

# Install Heroku CLI
# https://devcenter.heroku.com/articles/heroku-cli#download-and-install
# curl https://cli-assets.heroku.com/install-ubuntu.sh | sh
# heroku login
# heroku create
# git config --list
# git push heroku master

# heroko dyno interactive shell session 
# heroku run bash

# heroku run rake db:migrate

# Not sure about this command
# heroku ps:scale web=1

# heroku ps

# heroku open (opens your app on the browser)
# heroku logs
# heroku logs --tail
# heroku run rails console
# heroku run rake etc...

# Tell Heroku how to start the app using Procfile
# echo 'web: bundle exec puma -t 5:5 -p ${PORT:-3000} -e ${RACK_ENV:-development}' >> Procfile
# Or else it will just run your app is running rails s (but this is not suitable for production)
# Run heroku local and you will start your web server by executing the command in your Procfile


# Useful Heroku Links:
# https://devcenter.heroku.com/articles/getting-started-with-rails5
# https://devcenter.heroku.com/articles/procfile
# https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server
# https://devcenter.heroku.com/articles/config-vars
# https://devcenter.heroku.com/articles/connecting-to-heroku-postgres-databases-from-outside-of-heroku

